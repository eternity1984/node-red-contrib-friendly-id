<script type="text/javascript">
    RED.nodes.registerType("friendly-id", {
        category: 'function',
        color: '#C0C0C0',
        icon: "icon.svg",
        inputs: 1,
        outputs: 1,
        defaults: {
            name: {
                value: ""
            },
            mode: {
                value: "GENERATE-NANOID",
                required: true
            },
            charlen: {
                value: 21,
                required: true
            },
            charset: {
                value: "DEFAULT"
            },
            customs: {
                value: "",
                validate: function(v) {
                    var charset = $('#node-input-charset option:selected').val();
                    if (charset === "CUSTOM") {
                        if (v.length == 0) {
                            return false;
                        }
                        var duplicateCount = v.split("")
                            .filter(function(value, index, self) {
                                return self.indexOf(value) !== index;
                            }).length;
                        if (duplicateCount > 0) {
                            return false;
                        }
                        return RED.validators.regex(/[0-9A-Za-z]+/)(v)
                    }
                    return true;
                }
            },
            tostatus: {
                value: false
            },
            statusVal: {
                value: ""
            },
            statusType: {
                value: "auto"
            }
        },
        label: function() {
            return this.name || "friendly-id";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var node = this;
            var autoType = {
                value: "auto",
                label: node._("label.autoType"),
                hasValue: false
            };
            var givenValType = {
                value: "input",
                label: node._("label.givenValType"),
                hasValue: false
            }
            $("#node-input-typed-status").typedInput({
                default: "auto",
                types: [givenValType, autoType, "msg"],
                typeField: $("#node-input-statusType")
            });

            if (node.statusType === undefined) {
                $("#node-input-typed-status").typedInput('type', node._def.defaults.statusType.value);
            }
            if (node.statusVal === undefined) {
                $("#node-input-typed-status").typedInput('value', node._def.defaults.statusVal.value);
            }
            if (node.charlen === undefined) {
                $('#node-input-charlen').val(node._def.defaults.charlen.value);
            }
            if (node.charset === undefined) {
                $('#node-input-charset').val(node._def.defaults.charset.value);
            }

            $("#node-input-tostatus").change(function(e) {
                if ($(this).is(":checked")) {
                    $("#node-input-typed-status").typedInput('type', node.statusType);
                    $("#node-input-typed-status").typedInput('value', node.statusVal);
                    $("#node-tostatus-line").show();
                } else {
                    $("#node-tostatus-line").hide();
                    node.statusType = "auto";
                    node.statusVal = "";
                    $("#node-input-typed-status").typedInput('type', node.statusType);
                    $("#node-input-typed-status").typedInput('value', node.statusVal);
                }
            });

            $('#node-input-mode').change(function(e) {
                if ($('option:selected', this).val() === "GENERATE-NANOID") {
                    $('#node-nodeid-customs-line').hide();
                    $('#node-nodeid-line').show()
                } else {
                    $('#node-nodeid-line').hide()
                    node.charset = "DEFAULT";
                    $('#node-input-charset').val(node.charset);
                }
            });
            $('#node-input-charset').change(function(e) {
                if ($('option:selected', this).val() === "CUSTOM") {
                    $("#node-input-customs").val(node.customs || "");
                    $('#node-nodeid-customs-line').show();
                } else {
                    $('#node-nodeid-customs-line').hide();
                    node.customs = "";
                    $("#node-input-customs").val("");
                }
            });
        },
        oneditsave: function() {
            $("#node-input-statusVal").val($("#node-input-typed-status").typedInput('value'));
        }
    });
</script>

<script type="text/x-red" data-template-name="friendly-id">
    <div class="form-row">
        <label for="node-input-mode"><i class="fa fa-tasks"></i> <span data-i18n="label.mode.title"></span></label>
        <select type="text" id="node-input-mode" style="width:70%">
            <option value="ENCODE" data-i18n="label.mode._encode"></option>
            <option value="DECODE" data-i18n="label.mode._decode"></option>
            <option value="GENERATE-SHORTID" data-i18n="label.mode._shortid"></option>
            <option value="GENERATE-NANOID" data-i18n="label.mode._nanoid"></option>
        </select>
    </div>

    <div id="node-nodeid-line">
        <div class="form-row">
            <label for="node-input-charset"><i class="fa fa-keyboard-o"></i> <span data-i18n="label.charset.title"></span></label>
            <select type="text" id="node-input-charset" style="width:70%">
                <option value="DEFAULT" data-i18n="label.charset._default"></option>
                <option value="NUMERIC" data-i18n="label.charset._numbers" data-restricted="0123456789"></option>
                <option value="LOWERCASE" data-i18n="label.charset._lowercase" data-restricted="abcdefghijklmnopqrstuvwxyz"></option>
                <option value="UPPERCASE" data-i18n="label.charset._uppercase" data-restricted="ABCDEFGHIJKLMNOPQRSTUVWXYZ"></option>
                <option value="ALPHANUMERIC" data-i18n="label.charset._alphanumeric" data-restricted="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"></option>
                <option value="NO-LOOKALIKES" data-i18n="label.charset._nolookalikes" data-restricted="346789ABCDEFGHJKLMNPQRTUVWXYabcdefghijkmnpqrtwxyz"></option>
                <option value="NO-LOOKALIKES-SAFE" data-i18n="label.charset._nolookalikessafe" data-restricted="6789BCDFGHJKLMNPQRTWbcdfghjkmnpqrtwz"></option>
                <option value="CUSTOM" data-i18n="label.charset._custom"></option>
            </select>
        </div>
        <div class="form-row" id="node-nodeid-customs-line">
            <label for="node-input-customs"></label>
            <input type="text" id="node-input-customs" data-i18n="[placeholder]label.charset.unique">
        </div>

        <div class="form-row">
            <label for="node-input-charlen"><i class="fa fa-puzzle-piece"></i> <span data-i18n="label.charlen.title"></span></label>
            <input type="number" min="2" max="32" id="node-input-charlen" style="text-align:end; width:70px !important" oninput="this.value = Math.min(this.max, Math.max(this.min, this.value))">
        </div>
    </div>

    <hr>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>

    <div class="form-row">
        <label for="node-input-tostatus">&nbsp;</label>
        <label for="node-input-tostatus" style="width: 70%;">
            <input type="checkbox" id="node-input-tostatus" style="display: inline-block; width: auto; vertical-align: top;"> <span data-i18n="label.tostatus"></span>
        </label>
    </div>

    <div class="form-row" id="node-tostatus-line">
        <label for="node-input-typed-status">&nbsp;</label>
        <input id="node-input-typed-status" type="text" style="width: 70%">
        <input id="node-input-statusVal" type="hidden">
        <input id="node-input-statusType" type="hidden">
    </div>
</script>